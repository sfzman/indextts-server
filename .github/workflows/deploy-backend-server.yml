name: Deploy Backend Server to Aliyun SAE

on:
  push:
    branches:
      - main
    paths:
      - 'backend-server/**'
      - '.github/workflows/deploy-backend-server.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  REGION: ${{ secrets.ALIYUN_REGION }}
  ACR_REGISTRY: registry.${{ secrets.ALIYUN_REGION }}.aliyuncs.com
  ACR_NAMESPACE: ${{ secrets.ALIYUN_ACR_NAMESPACE }}
  IMAGE_NAME: indextts-backend-server
  SAE_APP_ID: ${{ secrets.SAE_BACKEND_SERVER_APP_ID }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Aliyun Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_REGISTRY }}
          username: ${{ secrets.ALIYUN_ACR_USERNAME }}
          password: ${{ secrets.ALIYUN_ACR_PASSWORD }}

      - name: Generate image tag
        id: image-tag
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          echo "tag=${TIMESTAMP}-${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "full_image=${{ env.ACR_REGISTRY }}/${{ env.ACR_NAMESPACE }}/${{ env.IMAGE_NAME }}:${TIMESTAMP}-${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./backend-server
          file: ./backend-server/Dockerfile
          push: true
          tags: |
            ${{ env.ACR_REGISTRY }}/${{ env.ACR_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ steps.image-tag.outputs.tag }}
            ${{ env.ACR_REGISTRY }}/${{ env.ACR_NAMESPACE }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Setup Aliyun CLI
        uses: aliyun/setup-aliyun-cli-action@v1
        with:
          aliyun-cli-version: '3.0.200'
          mode: 'AK'
          access-key-id: ${{ secrets.ALIYUN_ACCESS_KEY_ID }}
          access-key-secret: ${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}
          region-id: ${{ env.REGION }}

      - name: Configure Aliyun CLI profile
        run: |
          aliyun configure set \
            --profile default \
            --mode AK \
            --region ${{ env.REGION }} \
            --access-key-id ${{ secrets.ALIYUN_ACCESS_KEY_ID }} \
            --access-key-secret ${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}

      - name: Deploy to SAE
        run: |
          aliyun sae DeployApplication \
            --region ${{ env.REGION }} \
            --AppId ${{ env.SAE_APP_ID }} \
            --ImageUrl ${{ steps.image-tag.outputs.full_image }}

      - name: Wait for deployment
        run: |
          echo "Waiting for deployment to complete..."
          sleep 30

          # Check deployment status
          for i in {1..20}; do
            STATUS=$(aliyun sae DescribeApplicationStatus \
              --region ${{ env.REGION }} \
              --AppId ${{ env.SAE_APP_ID }} \
              --output json \
              --query 'Data.CurrentStatus' | tr -d '"')

            echo "Deployment status: $STATUS"

            if [ "$STATUS" = "RUNNING" ]; then
              echo "Deployment completed successfully!"
              exit 0
            elif [ "$STATUS" = "FAILED" ] || [ "$STATUS" = "UNKNOWN" ]; then
              echo "Deployment failed with status: $STATUS"
              exit 1
            fi

            echo "Waiting for deployment... (attempt $i/20)"
            sleep 15
          done

          echo "Deployment timeout"
          exit 1

      - name: Deployment summary
        if: success()
        run: |
          echo "## Backend Server Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`${{ steps.image-tag.outputs.full_image }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **SAE App ID**: \`${{ env.SAE_APP_ID }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: \`${{ env.REGION }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: Deployed successfully" >> $GITHUB_STEP_SUMMARY
